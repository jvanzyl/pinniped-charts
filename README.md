# Pinniped Helm Charts

A very nascent version of [Pinniped][1] Helm charts for Concierge, Supervisor and the Local User Authenticator. 

Process to generate the charts:

1. Ytt uber manifest is generated from Ytt files + Ytt values.
2. Ytt manifests are generated by kubectl-splice'ing the Ytt uber manifest.
3. Helm templates are generated by mutating the Ytt manifests. A limited number of variables are injected right now.
4. Helm charts are generated by adding some common chart content (`.helmignore` and `_helpers.tpl`) and specific chart content (`Chart.yaml` and `values.yaml`) to each chart.
5. Helm manifests are generated using `helm template` with the generated chart + Helm `values.yaml` for the specific chart.
6. Dyff of Ytt manifests vs Helm manifests is performed where each Ytt/Helm manifest pair needs to be canonically identical.

To be sure, if you look at the shell script to produce the charts you will cry. As noted in the script, I'm not sure if the script will continue to be used once verified to be working. But long term it may be better to always mechanically create the charts from the Ytt sources. Not sure.

## Todo

- [ ] Run the local Pinniped integration test. In theory this should work given the manifests produced by the two paths are identical (save for one).
- [ ] Figure out why the remaining single manifest does not register as canonically identical. I have added to an existing issue with Dyff here: https://github.com/homeport/dyff/issues/171
- [ ] Determine the structure of the Helm `values.yaml` files for each chart. This definitely needs work, I just plugged in values to achieve parity in the comparison.
- [ ] Generate a `values.schema.json` for each chart.
- [x] Add a named template for optionally injecting image pull secrets.

## Assumptions for Helm chart generation

The generated charts are checked in right now, so you don't have to generate the charts to try them, but if you want to generate the charts yourself then the following is assumed:

- The [pinniped repository][3] is cloned in a sibling directory named `pinniped`.
- You have `ytt` on your path: https://carvel.dev/ytt
- You have `kubectl-splice` on your path: https://github.com/patrickdappollonio/kubectl-slice
- You have `yq` on your path: https://github.com/mikefarah/yq
- You have `dyff` on your path: https://github.com/homeport/dyff

[1]: https://pinniped.dev
[2]: https://github.com/vmware-tanzu/pinniped/tree/main/deploy
[3]: https://github.com/vmware-tanzu/pinniped.git